class CardPile
  constructor: ->
    @cards = []
    @positionTop = 0
    @positionLeft = 0

  cardPosition: (card) ->
    top: @positionTop
    left: @positionLeft

  shuffle: ->
    ###
    Fisher Yates Shuffle algorithm for arrays
    ###
    i = @cards.length
    if i is 0
      return false

    while --i
      j = Math.floor( Math.random() * ( i + 1 ) )
      tempi = @cards[i]
      tempj = @cards[j]
      @cards[i] = tempj
      @cards[j] = tempi

  push: (card) ->
    card.currentPile = @
    @cards.push card

  takeNextCard: () ->
    @cards.shift()

  takeAllCards: () ->
    @cards.splice 0

  getSaveData: ->
    cards = []
    for card in @cards
      cards.push card.getSaveData()
    return {
      cards: cards
    }

  loadData: (data) ->
    @cards.length = 0
    for card in data.cards
      card = new Card(card.value, card.suit)
      @push card

class UnusedCardPile extends CardPile
  constructor: ->
    super()
    @positionTop = 160 + "px"
    @positionLeft = 0

class UsedCardPile extends CardPile
  constructor: ->
    super()
    @positionTop = 160 + "px"
    @positionLeft = 270 + "px"

  push: (card) ->
    super(card)
    card.isFlipped = no

class PlayerCardPile extends CardPile
  constructor: (positionTop, positionLeft) ->
    super()
    @positionTop = positionTop
    @positionLeft = positionLeft
    @isRevealingAll = yes

  push: (card) ->
    super(card)
    if @isRevealingAll or @cards.length is 1
      card.isFlipped = yes

  reveal: ->
    @isRevealingAll = yes
    for card in @cards
      card.isFlipped = yes

  value: ->
    if !@cards.length
      return 0

    if !@isRevealingAll
      return "?"

    handValue = 0
    aceCount = 0

    for card in @cards
      switch card.value
        when "A"
          aceCount++
        when "J","Q","K"
          handValue += 10
        else
          handValue += card.value

    if aceCount?
      for i in [0...aceCount]
        if handValue <= 10
          handValue += 11
        else
          handValue += 1

    return handValue

  cardPosition: (card) ->
    for pileCard, i in @cards
      if pileCard is card
        return {
        "top": @positionTop + "px"
        "left": @positionLeft + (i * 30 - @cards.length * 15) + "px"
        "z-index": i
        }

class PlayerInventoryCardPile extends CardPile